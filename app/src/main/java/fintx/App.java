/*
 * This Java source file was generated by the Gradle 'init' task.
 */
package fintx;

import fintx.digest.DigestResult;
import fintx.digest.RakutenCsvStatementDigester;
import java.io.File;
import java.util.Optional;
import java.util.concurrent.Callable;
import picocli.CommandLine;

@CommandLine.Command
public class App implements Callable<DigestResult> {

    private static final int SUCCESS = 0;
    private static final int FAIL = 1;

    @CommandLine.Parameters(description = "file to digest")
    private File file;

    public static void main(String[] args) {
        final CommandLine commandLine = new CommandLine(new App());
        final int cmomandLineExitCode = commandLine.execute(args);
        final Optional<DigestResult> result = Optional.ofNullable(commandLine.getExecutionResult());
        result.ifPresent(
                res -> {
                    if (!res.errors().isEmpty()) {
                        System.err.println("ERRORS ENCOUNTERED:");
                        res.errors().forEach(System.err::println);
                    }
                    if (!res.transactions().isEmpty()) {
                        System.err.println("TRANSACTIONS:");
                        res.transactions().forEach(System.out::println);
                    }
                });
        final int finalExitCode =
                result.map(
                                res ->
                                        (!res.errors().isEmpty() && cmomandLineExitCode == SUCCESS)
                                                ? FAIL
                                                : cmomandLineExitCode)
                        .orElse(SUCCESS);
        System.exit(finalExitCode);
    }

    @Override
    public DigestResult call() {
        return new RakutenCsvStatementDigester().digest(file);
    }
}
